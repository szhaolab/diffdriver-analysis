---
title: "Clinical"
author: "Qirui Zhang"
date: "2025-05-21"
output: 
  html_document:
    theme: flatly
    highlight: tango
    toc: true
    toc_float: true
---

```{r}
knitr::opts_chunk$set(echo = TRUE)
```

# Overview

In total, **160 analyses** were conducted across **20 tumor types**, involving the following **6 distinct phenotypes**:

- Aneuploidy Score  
- Fraction Genome Altered  
- Months of Disease-specific Survival  
- Tumor Mutation Burden (TMB nonsynonymous)  
- Diagnosis Age  
- Progression-Free Survival Months  

All **120 analyses** were successfully completed without errors.

# Extracting and Summarizing Analysis Results
This code segment scans through analysis output directories, identifies relevant result files (*_resdd.Rd), extracts corresponding tumor types, immune phenotypes, and analysis modes(sig/reg).
```{r}
get_files <- function(outputdir, tumors = NULL, phenotypes = NULL) {
  files <- list.files(
    path = outputdir,
    pattern = "_resdd\\.Rd$",
    recursive = TRUE,
    full.names = TRUE
  )
  
  matching_files_txt <- sub("\\.Rd$", ".txt", files)
  
  analysis_mode <- ifelse(grepl("_sig_", basename(files)), "sig", "reg")

  inner_folder_names      <- basename(dirname(files))            # e.g. "Aneuploidy.Score_BLCA_mutations"
  phenotype_folder_names  <- basename(dirname(dirname(files)))   # e.g. "Aneuploidy.Score"
  
  tumor_names <- mapply(function(inner_name, phen) {
    pattern_front <- paste0("^", phen, "_")
    tmp <- sub(pattern_front, "", inner_name)
    tmp <- sub("_mutations$", "", tmp)
    return(tmp)
  }, inner_folder_names, phenotype_folder_names)
  
  phenos_all <- phenotype_folder_names
  
  filedf <- data.frame(
    tumor      = tumor_names,
    phenotype  = phenos_all,
    mode       = analysis_mode,   
    file       = files,
    filetxt    = matching_files_txt,
    stringsAsFactors = FALSE
  )
  
  if (!is.null(tumors)) {
    filedf <- filedf[filedf$tumor %in% tumors, ]
  }
  if (!is.null(phenotypes)) {
    filedf <- filedf[filedf$phenotype %in% phenotypes, ]
  }

  rownames(filedf) <- NULL
  return(filedf)
}

filedf <- get_files(
  outputdir = "/dartfs/rc/lab/S/Szhao/qiruiz/diffdriver/temp/output/new_plot/clinical"
)

head(filedf)
```

# Summary Table of Significant Differential Genes
The provided function extracts and compiles results from analyses, filtering specifically for significant differential genes based on a threshold (**`dd.fdr < 0.1`**). 
```{r}
get_diff_table <- function(filedf, include_nonsig = TRUE){
  pheno_all <- unique(filedf$phenotype)
  numlist <- list()
  
  for (p in pheno_all){
    p_txtfiles <- filedf[filedf$phenotype == p, ]
    numlist[[p]] <- list()
    
    for (t in seq_len(nrow(p_txtfiles))){
      txtf  <- p_txtfiles[t, "filetxt"]
      rdf   <- p_txtfiles[t, "file"] 
      tumor <- p_txtfiles[t, "tumor"] 
      mode  <- p_txtfiles[t, "mode"]     # reg / sig
      
      env <- new.env()
      load(rdf, envir = env)
      res_rdata <- env$res
      
      res <- read.table(txtf, header = TRUE)
      res$gene <- row.names(res)
      res$mode <- mode
      
      res$alpha <- sapply(res$gene, function(gene){
          res_rdata[[gene]][["dd"]][["res.alt"]]$alpha[2]
      })
      
      res$significant <- res$dd.fdr < 0.1
      
      if (include_nonsig) {
        numlist[[p]][[ paste0(tumor, "_", mode) ]] <- res
      } else {
        sig_res <- res[res$dd.fdr < 0.1, ]
        if (nrow(sig_res) > 0){
          numlist[[p]][[ paste0(tumor, "_", mode) ]] <- sig_res
        }
      }
    }
    
    if (length(numlist[[p]]) == 0){
      numlist[[p]] <- NULL
    }
  }
  
  combined_df <- do.call(
    rbind,
    lapply(names(numlist), function(pheno) {
      numlist.pheno <- numlist[[pheno]]
      df.pheno <- do.call(rbind, lapply(names(numlist.pheno), function(tname) {
        df <- numlist.pheno[[tname]]
        df$tumor <- sub("_.*", "", tname) 
        df$mode  <- sub(".*_", "", tname) 
        return(df)
      }))
      df.pheno$pheno <- pheno
      return(df.pheno)
    })
  )
  return(combined_df)
}

diff_table_all <- get_diff_table(filedf, include_nonsig = TRUE)
diff_table <-  get_diff_table(filedf, include_nonsig = FALSE)
```

## Table under "Sig" Mode
```{r}
library(DT)
diff_table_sig <- subset(diff_table, mode == "sig")
datatable(
  diff_table_sig,
  extensions = 'Buttons',
  options = list(
    dom        = 'Bfrtip', 
    buttons    = c('copy', 'csv', 'excel', 'pdf', 'print'),
    pageLength = 10
  )
)
```

## Table under "Reg" Mode
```{r}
diff_table_reg <- subset(diff_table, mode == "reg")
datatable(
  diff_table_reg,
  extensions = 'Buttons',
  options = list(
    dom        = 'Bfrtip', 
    buttons    = c('copy', 'csv', 'excel', 'pdf', 'print'),
    pageLength = 10
  )
)
```

# Plotting the Number of Significant Differential Genes
The provided function generates bar plots illustrating the number of significantly differentially expressed genes (**`dd.fdr < 0.1`**) for each tumor type across different phenotype contexts.
```{r}
library(scales)

plot_diff_number <- function(filedf, mode = c("reg", "sig")){
  
  filedf <- filedf[filedf$mode == mode, ]
  
  pheno_all <- unique(filedf$phenotype)
  numlist <- list()
  
  pt <- scales::pseudo_log_trans()
  
  for (p in pheno_all){
    p_txtfiles <- filedf[filedf$phenotype == p, ]
    numlist[[p]] <- list()
    for (t in 1:nrow(p_txtfiles)){
      txtf <- p_txtfiles[t, "filetxt"]
      tumor <- p_txtfiles[t, "tumor"]
      res <- read.table(txtf, header = TRUE)
      numlist[[p]][[tumor]] <- c(
        nrow(res[res$dd.fdr < 0.1,]),
        nrow(res) - nrow(res[res$dd.fdr < 0.1,])
      )
    }
  }
  
  par(mfrow = c(length(numlist),1), mar = c(3,5,2,0))
  for (phenotype in names(numlist)) {
    colors <- rainbow(length(numlist[[phenotype]]))
    max_height <- max(unlist(lapply(numlist[[phenotype]], function(x) sum(x))))
    
    max_plot_height <- pt$transform(max_height)
    
    plot(
      NULL,
      xlim = c(0.5, length(numlist[[phenotype]]) + 0.5),
      ylim = c(0, max_plot_height * 1.1),
      xlab = "Tumor Type",
      ylab = "No. Genes",
      main = paste("Context:", phenotype),
      xaxt = "n", yaxt = "n", bty = 'n'
    )
    
    y_ticks <- c(0, 1, 2, 5, 10, 30, 60)
    y_ticks <- y_ticks[y_ticks <= max_height]
    axis(2, at = pt$transform(y_ticks), labels = y_ticks)
    
    grid()

    axis(
      1,
      at = 1:length(numlist[[phenotype]]),
      labels = names(numlist[[phenotype]]),
      las = 2
    )
    
    for (i in seq_along(numlist[[phenotype]])) {
      sig_count <- numlist[[phenotype]][[i]][1]
      nonsig_count <- numlist[[phenotype]][[i]][2]

      rect(i - 0.4, pt$transform(sig_count), i + 0.4, 
          pt$transform(sig_count + nonsig_count),
          col = adjustcolor(colors[i], alpha.f = 0.15), 
          border = NA)
      
      if (sig_count > 0) {
        rect(i - 0.4, pt$transform(0), i + 0.4, pt$transform(sig_count),
             col = colors[i], border = NA)
        text(i, pt$transform(sig_count) * 1.2, sig_count, cex = 0.7)
      }
    }
    
  }
}
```

## Visualization under "Sig" Mode
```{r, fig.width=7, fig.height=10} 
plot_diff_number(filedf, mode = "sig")
```

## Visualization under "Reg" Mode
```{r, fig.width=7, fig.height=10} 
plot_diff_number(filedf, mode = "reg")
```

# Multi-Faceted Dot Plot for Differential Gene Analysis
This function generates a series of dot plots to illustrate differential gene analysis results across various tumors and phenotypes. Each plot highlights significance (positive, negative, non-significant), p-values, and relative effect sizes.
```{r}
library(dplyr)
library(ggplot2)

plot_diff_gene <- function(diff_table_all, filedf, mode = c("sig", "reg")) {
  dt <- diff_table_all[diff_table_all$mode == mode, ]
  
  all_tumors <- sort(unique(filedf$tumor))
  all_phenos <- sort(unique(filedf$phenotype))
   
  dt <- dt %>%
    mutate(
      tumor = factor(tumor, levels = all_tumors),
      pheno = factor(pheno, levels = all_phenos)
    )
  
  gene_order <- dt %>%
    group_by(gene) %>%
    summarise(n = n()) %>%
    arrange(desc(n)) %>%
    pull(gene)
  
  dt <- dt %>% mutate(gene = factor(gene, levels = gene_order))

  all_genes  <- levels(dt$gene)

  plots_list <- list()

  for (current_gene in all_genes) {
    df_gene <- dt %>% filter(gene == current_gene)
    
    full_grid <- expand.grid(
      tumor = all_tumors,
      pheno = all_phenos,
      KEEP.OUT.ATTRS = FALSE
    )
    full_grid$tumor <- factor(full_grid$tumor, levels = all_tumors)
    full_grid$pheno <- factor(full_grid$pheno, levels = all_phenos)
    
    df_plot <- full_grid %>%
      left_join(df_gene, by = c("tumor", "pheno")) %>%
      mutate(
        signcat = case_when(
          is.na(significant)                 ~ "none",
          significant == FALSE               ~ "ns",
          significant == TRUE & alpha > 0    ~ "pos",
          significant == TRUE & alpha < 0    ~ "neg"
        ),
        pvalue = dd.p,
        log_pvalue = case_when(
          !is.na(dd.p) & dd.p > 0 ~ -log10(dd.p),
          !is.na(dd.p) & dd.p == 0 ~ 10,
          TRUE ~ NA_real_
        ),
        signed_log_pvalue = case_when(
          signcat == "pos" ~ log_pvalue,
          signcat == "neg" ~ -log_pvalue,
          TRUE ~ NA_real_
        )
    ) %>%
    group_by(pheno) %>%
      mutate(
        ref_alpha = median(abs(alpha), na.rm = TRUE),  # mean/max/a specified tumor
        ratio_alpha = if_else(is.na(ref_alpha) | ref_alpha == 0, 
                              NA_real_, 
                              abs(alpha) / ref_alpha), 
        size_value = case_when(
          signcat %in% c("pos", "neg", "ns") ~ ratio_alpha,
          TRUE                               ~ NA_real_
        )
      ) %>%
      ungroup()
    
    p <- ggplot() +
      # For significant points (both positive and negative)
      geom_point(
        data = df_plot %>% filter(signcat %in% c("pos", "neg")),
        aes(x = tumor, y = pheno, size = size_value, fill = signed_log_pvalue),
        shape = 21,
        color = "black", 
        stroke = 0.2, 
        na.rm = TRUE
      ) +
      # For non-significant points
      geom_point(
        data = df_plot %>% filter(signcat == "ns"),
        aes(x = tumor, y = pheno, size = size_value),
        shape = 21,
        fill = "grey90",
        color = "black",
        stroke = 0.2,
        alpha = 0.3,
        na.rm = TRUE
      ) +
      geom_blank(
        data = df_plot %>% filter(signcat == "none"),
        aes(x = tumor, y = pheno)
      ) +
      
      scale_fill_gradient2(
        low = "darkblue", 
        mid = "white",
        high = "darkred",
        midpoint = 0,
        name = "Directional Significance\n(-log10 p-value)",
        guide = guide_colorbar(direction = "vertical"),
        na.value = "orange",
        limits = c(-10, 10),
        oob = scales::squish
      ) +
  
      scale_size_continuous(
        range = c(1, 8), 
        name = "Relative size (|alpha| / ref)"
      ) +
      
      scale_x_discrete(drop = FALSE) +
      scale_y_discrete(drop = FALSE) +
      
      theme_bw(base_size = 14) +
      theme(
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
        legend.position = "right",
        legend.box = "vertical"
      ) +
      labs(
        x = "Tumor",
        y = "Phenotype",
        title = paste("Gene:", current_gene, "Mode:", mode)
      )
    
    plots_list[[current_gene]] <- p
  }
  
  return(plots_list)
}
```

```{r, fig.width=10, fig.height=5}
plots <- plot_diff_gene(diff_table_all, filedf, mode = "sig")
print(plots[["TP53"]])
print(plots[["KRAS"]])
```

# GSEA
We organized our differential analysis data into eight gene sets through a two-step process. First, we filtered the full `diff_table_sig` table by each phenotype of interest—non-synonymous TMB, disease-specific survival and progression-free survival, diagnosis age, and genomic instability metrics (fraction genome altered and aneuploidy score)—to create four initial subsets (`tmb`, `survival`, `age`, `instability`). Second, within each subset we partitioned genes by the sign of their effect size (`alpha > 0` for positively associated genes, `alpha < 0` for negatively associated genes), yielding eight final groups (`tmb_pos`/`tmb_neg`, `survival_pos`/`survival_neg`, `age_pos`/`age_neg`, `instability_pos`/`instability_neg`). These groups serve as the candidate ranked gene lists for downstream GSEA.
```{r}
library(msigdbr)
library(clusterProfiler)
library(org.Hs.eg.db)
library(GseaVis)

tmb         <- subset(diff_table_sig, pheno == "TMB.nonsynonymous")

survival    <- subset(diff_table_sig, pheno %in% c("Months.of.disease.specific.survival",
                                                   "Progress.Free.Survival.Months"))

age         <- subset(diff_table_sig, pheno == "Diagnosis.Age")

instability <- subset(diff_table_sig, pheno %in% c("Fraction.Genome.Altered",
                                                   "Aneuploidy.Score"))

tmb_pos <- subset(tmb, alpha >  0)
tmb_neg <- subset(tmb, alpha <  0)

survival_pos <- subset(survival, alpha >  0)
survival_neg <- subset(survival, alpha <  0)

age_pos <- subset(age, alpha >  0)
age_neg <- subset(age, alpha <  0)

instability_pos <- subset(instability, alpha >  0)
instability_neg <- subset(instability, alpha <  0)
```

```{r}
dfs <- list(
  tmb_pos         = tmb_pos,
  tmb_neg         = tmb_neg,
  survival_pos    = survival_pos,
  survival_neg    = survival_neg,
  age_pos         = age_pos,
  age_neg         = age_neg,
  instability_pos = instability_pos,
  instability_neg = instability_neg
)

df_list <- lapply(dfs, function(subdf) {
  data.frame(
    rowname = rownames(subdf),
    gene    = subdf$gene,
    stringsAsFactors = FALSE
  )
})

max_n <- max(sapply(df_list, nrow))

df_list_padded <- lapply(df_list, function(x) {
  if (nrow(x) < max_n) {
    n_pad <- max_n - nrow(x)
    pad <- data.frame(
      rowname = rep(NA, n_pad),
      gene    = rep(NA, n_pad),
      stringsAsFactors = FALSE
    )
    x <- rbind(x, pad)
  }
  x
})

wide_df <- do.call(cbind, df_list_padded)

colnames(wide_df) <- unlist(lapply(names(df_list_padded), function(nm) {
  c(paste0(nm, "_row"), paste0(nm, "_gene"))
}))

datatable(
  wide_df,
  extensions = 'Buttons',
  options = list(
    dom        = 'Bfrtip',
    buttons    = c('copy', 'csv', 'excel', 'pdf', 'print'),
    pageLength = 45
  )
)
```

```{r}
h.kegg <- msigdbr(
  species      = "Homo sapiens",
  collection   = "C2",
  subcollection= "CP:KEGG_LEGACY"
)[, c("gs_name", "gene_symbol")]

tables <- list(
  tmb_pos        = tmb_pos, 
  tmb_neg        = tmb_neg,
  survival_pos   = survival_pos, 
  survival_neg   = survival_neg,
  age_pos        = age_pos, 
  age_neg        = age_neg,
  instability_pos= instability_pos, 
  instability_neg= instability_neg
)

gsea_results <- list()

for (nm in names(tables)) {
  tbl <- tables[[nm]]
  
  tbl_unique <- tbl %>%
    group_by(gene) %>%
    summarise(alpha = mean(alpha), .groups = "drop")

  deg <- tbl_unique$alpha
  names(deg) <- tbl_unique$gene
  deg <- sort(deg, decreasing = TRUE)
  
  scoreType <- if      (min(deg) >= 0) "pos"
               else if (max(deg) <= 0) "neg"
  
  gsea <- GSEA(
    geneList     = deg,
    TERM2GENE    = h.kegg,
    pvalueCutoff = 0.5,
    scoreType    = scoreType
  )
  gsea_results[[nm]] <- gsea
  
  if (!is.null(gsea) && nrow(gsea@result) > 0) {
    dotplot(gsea, showCategory = 10, title = nm)
  } else {
    message(sprintf("[%s] No enriched terms with p ≤ 0.5", nm))
  }
}

library(enrichplot)
gseaplot2(
  gsea_results$instability_neg, 
  geneSetID = 1,
  pvalue_table = TRUE, 
  title = gsea_results$instability_neg@result$Description[1]
)
```
## KEGG GSEA
```{r}
kegg_t2g <- msigdbr(
  species       = "Homo sapiens",
  collection    = "C2",
  subcollection = "CP:KEGG_LEGACY"
)[, c("gs_name", "gene_symbol")]

groups <- list(
  tmb_pos         = tmb_pos,  
  tmb_neg         = tmb_neg,
  survival_pos    = survival_pos,  
  survival_neg    = survival_neg,
  age_pos         = age_pos,  
  age_neg         = age_neg,
  instability_pos = instability_pos,  
  instability_neg = instability_neg
)

for (nm in names(groups)) {

  df <- groups[[nm]] |>
        group_by(gene) |>
        summarise(alpha = mean(alpha), .groups = "drop")

  gene_list <- sort(setNames(df$alpha, df$gene), decreasing = TRUE)
  if (length(gene_list) < 10) {
    message(nm, ": too few genes – skipped.")
    next
  }

  scoreType <- if      (min(gene_list) >= 0) "pos" 
               else if (max(gene_list) <= 0) "neg" 
               else                     NULL

  gsea <- GSEA(
    geneList     = gene_list,
    TERM2GENE    = kegg_t2g,
    pvalueCutoff = 0.5,
    scoreType    = scoreType
  )

  if (nrow(gsea@result) == 0) {
    message(nm, ": no significant pathways.")
    next
  }

  cat("\n==== ", nm, " × KEGG ====\n")
  print(head(gsea@result[, c("ID","Description","p.adjust","NES")], 10))

  print(dotplot(gsea, showCategory = 10,
                title = paste0(nm, " × KEGG")))

  for (id in head(gsea@result$ID, 3)) {
    print(
      gseaNb(object    = gsea,
             geneSetID = id,
             addPval   = TRUE,
             pvalY     = 0.8)
    )
  }
}
```

## GO-BP GSEA
```{r}
gobp_t2g <- msigdbr(
  species     = "Homo sapiens",
  category    = "C5",
  subcategory = "GO:BP"
)[, c("gs_name", "gene_symbol")]

for (nm in names(groups)) {

  df <- groups[[nm]] |>
        group_by(gene) |>
        summarise(alpha = mean(alpha), .groups = "drop")

  gene_list <- sort(setNames(df$alpha, df$gene), decreasing = TRUE)
  if (length(gene_list) < 10) {
    message(nm, ": too few genes – skipped.")
    next
  }

  scoreType <- if      (min(gene_list) >= 0) "pos" 
               else if (max(gene_list) <= 0) "neg" 
               else                     NULL

  gsea <- GSEA(
    geneList     = gene_list,
    TERM2GENE    = gobp_t2g,
    pvalueCutoff = 0.5,
    scoreType    = scoreType
  )

  if (nrow(gsea@result) == 0) {
    message(nm, ": no significant pathways.")
    next
  }

  cat("\n==== ", nm, " × GO-BP ====\n")
  print(head(gsea@result[, c("ID","Description","p.adjust","NES")], 10))
  print(dotplot(gsea, showCategory = 10, title = paste0(nm, " × GO-BP")))

  for (id in head(gsea@result$ID, 3)) {
    print(gseaNb(object = gsea, geneSetID = id, addPval = TRUE, pvalY = 0.8))
  }
}
```

## GO-MF GSEA
```{r}
gomf_t2g <- msigdbr(
  species     = "Homo sapiens",
  category    = "C5",
  subcategory = "GO:MF"
)[, c("gs_name", "gene_symbol")]

for (nm in names(groups)) {
  
  df <- groups[[nm]] %>%
    group_by(gene) %>%
    summarise(alpha = mean(alpha), .groups = "drop")
  
  gene_list <- sort(setNames(df$alpha, df$gene), decreasing = TRUE)
  if (length(gene_list) < 10) {
    message(nm, ": too few genes – skipped.")
    next
  }
  
  scoreType <- if      (min(gene_list) >= 0) "pos" 
               else if (max(gene_list) <= 0) "neg" 
               else                     NULL
  
  gsea <- GSEA(
    geneList     = gene_list,
    TERM2GENE    = gomf_t2g,
    pvalueCutoff = 0.5,
    scoreType    = scoreType
  )
  
  if (nrow(gsea@result) == 0) {
    message(nm, ": no significant pathways.")
    next
  }
  
  cat("\n==== ", nm, " × GO-MF ====\n")
  print(head(gsea@result[, c("ID","Description","p.adjust","NES")], 10))
  print(dotplot(gsea, showCategory = 10, title = paste0(nm, " × GO-MF")))
  for (id in head(gsea@result$ID, 3)) {
    print(gseaNb(gsea, geneSetID = id, addPval = TRUE, pvalY = 0.8))
  }
}
```

## GO-CC GSEA
```{r}
gocc_t2g <- msigdbr(
  species     = "Homo sapiens",
  category    = "C5",
  subcategory = "GO:CC"
)[, c("gs_name", "gene_symbol")]

for (nm in names(groups)) {
  df <- groups[[nm]] %>%
    group_by(gene) %>%
    summarise(alpha = mean(alpha), .groups = "drop")
  
  gene_list <- sort(setNames(df$alpha, df$gene), decreasing = TRUE)
  if (length(gene_list) < 10) {
    message(nm, ": too few genes – skipped.")
    next
  }
  
  scoreType <- if      (min(gene_list) >= 0) "pos" 
               else if (max(gene_list) <= 0) "neg" 
               else                     NULL
  
  gsea <- GSEA(
    geneList     = gene_list,
    TERM2GENE    = gocc_t2g,
    pvalueCutoff = 0.5,
    scoreType    = scoreType
  )
  
  if (nrow(gsea@result) == 0) {
    message(nm, ": no significant pathways.")
    next
  }
  
  cat("\n==== ", nm, " × GO-CC ====\n")
  print(head(gsea@result[, c("ID","Description","p.adjust","NES")], 10))
  print(dotplot(gsea, showCategory = 10, title = paste0(nm, " × GO-CC")))
  for (id in head(gsea@result$ID, 3)) {
    print(gseaNb(gsea, geneSetID = id, addPval = TRUE, pvalY = 0.8))
  }
}
```

## Hallmark GSEA
```{r}
hallmark_t2g <- msigdbr(
  species  = "Homo sapiens",
  category = "H"
)[, c("gs_name", "gene_symbol")]

for (nm in names(groups)) {

  df <- groups[[nm]] |>
        group_by(gene) |>
        summarise(alpha = mean(alpha), .groups = "drop")

  gene_list <- sort(setNames(df$alpha, df$gene), decreasing = TRUE)
  if (length(gene_list) < 10) {
    message(nm, ": too few genes – skipped.")
    next
  }

  scoreType <- if      (min(gene_list) >= 0) "pos" 
               else if (max(gene_list) <= 0) "neg" 
               else                     NULL

  gsea <- GSEA(
    geneList     = gene_list,
    TERM2GENE    = hallmark_t2g,
    pvalueCutoff = 0.5,
    scoreType    = scoreType
  )

  if (nrow(gsea@result) == 0) {
    message(nm, ": no significant pathways.")
    next
  }

  cat("\n==== ", nm, " × Hallmark ====\n")
  print(head(gsea@result[, c("ID","Description","p.adjust","NES")], 10))

  print(dotplot(gsea, showCategory = 10,
                title = paste0(nm, " × Hallmark")))

  for (id in head(gsea@result$ID, 3)) {
    print(
      gseaNb(object     = gsea,
             geneSetID  = id,
             addPval    = TRUE,
             pvalY      = 0.8)
    )
  }
}
```

# ORA
```{r}
library(clusterProfiler)
gene_lists <- list(
  tmb_pos         = unique(tmb_pos$gene),
  tmb_neg         = unique(tmb_neg$gene),
  survival_pos    = unique(survival_pos$gene),
  survival_neg    = unique(survival_neg$gene),
  age_pos         = unique(age_pos$gene),
  age_neg         = unique(age_neg$gene),
  instability_pos = unique(instability_pos$gene),
  instability_neg = unique(instability_neg$gene)
)
```

## GO-BP ORA
```{r}
for (nm in names(gene_lists)) {
  genes   <- gene_lists[[nm]]
  ego_bp  <- enrichGO(
    gene          = genes,
    OrgDb         = org.Hs.eg.db,
    keyType       = "SYMBOL",
    ont           = "BP",
    pAdjustMethod = "BH",
    pvalueCutoff  = 0.05,
    qvalueCutoff  = 0.20
  )
  
  message("---- Group: ", nm, " | Number of enriched GO-BP terms = ", nrow(ego_bp@result))
  print(head(ego_bp@result, 3))  # Print the first 3 rows

  if (nrow(ego_bp@result) > 0) {
    print(dotplot(ego_bp, showCategory = 10, title = paste(nm, "GO-BP")))
  } else {
    message("   -> No significant GO-BP terms found; skipping plot.")
  }
}
```

## GO-CC ORA
```{r}
for (nm in names(gene_lists)) {
  genes <- gene_lists[[nm]]
  
  ego_cc <- enrichGO(
    gene          = genes,
    OrgDb         = org.Hs.eg.db,
    keyType       = "SYMBOL",
    ont           = "CC",
    pAdjustMethod = "BH",
    pvalueCutoff  = 0.05,
    qvalueCutoff  = 0.20
  )
  
  nTerm <- nrow(ego_cc@result)
  message("---- Group: ", nm,
          " | Number of enriched GO-CC terms = ", nTerm)
  print(head(ego_cc@result, 3))
  
  if (nTerm > 0) {
    nToShow <- min(10, nTerm)
    
    tryCatch({
      print(                 
        dotplot(
          ego_cc,
          showCategory = nToShow,
          title        = paste(nm, "GO-CC")
        )
      )
      
    }, error = function(e) {   
       message("   -> Plotting failed for ", nm, " (KEGG).")
    })
    
  } else {
    message("   -> No significant GO-CC terms found; skipping plot.")
  }
}

```

## GO-MF ORA
```{r}
for (nm in names(gene_lists)) {
  genes   <- gene_lists[[nm]]
  ego_mf  <- enrichGO(
    gene          = genes,
    OrgDb         = org.Hs.eg.db,
    keyType       = "SYMBOL",
    ont           = "MF",
    pAdjustMethod = "BH",
    pvalueCutoff  = 0.05,
    qvalueCutoff  = 0.20
  )
  
  message("---- Group: ", nm, " | Number of enriched GO-MF terms = ", nrow(ego_mf@result))
  print(head(ego_mf@result, 3))  # Print the first 3 rows

  if (nrow(ego_mf@result) > 0) {
    print(dotplot(ego_mf, showCategory = 10, title = paste(nm, "GO-MF")))
  } else {
    message("   -> No significant GO-MF terms found; skipping plot.")
  }
}
```

## KEGG ORA
```{r}
for (nm in names(gene_lists)) {
  genes <- gene_lists[[nm]]
  
  gene_entrez <- bitr(
    genes,
    fromType = "SYMBOL",
    toType   = "ENTREZID",
    OrgDb    = org.Hs.eg.db
  )
  
  ego_kegg <- enrichKEGG(
    gene          = gene_entrez$ENTREZID,
    organism      = "hsa",
    pAdjustMethod = "BH",
    pvalueCutoff  = 0.05,
    qvalueCutoff  = 0.20
  )
  
  nTerm <- nrow(ego_kegg@result)
  message("---- Group: ", nm, " | Number of enriched KEGG pathways = ", nTerm)
  print(head(ego_kegg@result, 3))
  
  if (nTerm > 0) {
    nToShow <- min(10, nTerm)
    
    tryCatch({
      print(
        dotplot(
          ego_kegg,
          showCategory = nToShow,
          title        = paste(nm, "KEGG")
        )
      )
    }, error = function(e) {
       message("   -> Plotting failed for ", nm, " (KEGG).")
    })
    
  } else {
    message("   -> No significant KEGG pathways found; skipping plot.")
  }
}
```

# Plot specific genes
To visualize the data for specific genes, diffdriver has a plotting function:
```{r}
mut_path <- "/dartfs/rc/lab/S/Szhao/qiruiz/diffdriver/tumor_specific_input/HNSC/HNSC_mutations.txt"
mut <- read.table(mut_path, header = TRUE, sep = "\t")
head(mut)
```

```{r}
pheno_path <- "/dartfs/rc/lab/S/Szhao/qiruiz/diffdriver/cbioportal_download/Aneuploidy.Score.txt"
pheno <- read.table(pheno_path, header = TRUE, sep = "\t")
head(pheno)
```

```{r}
diffdriver::plot_mut(gene_name = "CDKN2A", mut= mut, pheno = pheno, totalnttype = 96, 
                     anno_dir =  "/dartfs/rc/lab/S/Szhao/qiruiz/diffdriver/temp/annodir96")
```
