---
title: "Diversity"
author: "Qirui Zhang"
date: "2025-04-08"
output: 
  html_document:
    theme: flatly
    highlight: tango
    toc: true
    toc_float: true
---

```{r}
knitr::opts_chunk$set(echo = TRUE)
```

# Overview

In total, **420 analyses** were conducted across **20 tumor types**, each classified into **21 distinct immune phenotypes** (Abundance_IGH, Abundance_IGL, Abundance_TRB, Abundance_TRG, Clonality_IGK, Clonality_TRA, Clonality_TRD, Entropy_IGH, Entropy_IGL, Entropy_TRB, Entropy_TRG, Abundance_IGK, Abundance_TRA, Abundance_TRD, Clonality_IGH, Clonality_IGL, Clonality_TRB, Clonality_TRG, Entropy_IGK, Entropy_TRA, Entropy_TRD). Of these, **140 analyses completed successfully**, while **280 encountered errors**. The specific tumor type and phenotype combinations corresponding to unsuccessful analyses are detailed below.

# Summary of Unsuccessful Analyses

The table below summarizes analyses that failed, along with explanations for their failure:

```{r, echo=FALSE}
library(knitr)
library(kableExtra)

failure_data <- data.frame(
  Combination = c("Entropy_TRG_ESCA_mutations",
                  "Entropy_TRG_PRAD_mutations",
                  "Entropy_TRG_KIRC_mutations",
                  "Entropy_TRG_KIRP_mutations",
                  "Entropy_TRG_LUAD_mutations",
                  "Entropy_TRG_BRCA_mutations",
                  "Entropy_TRG_KICH_mutations",
                  "Entropy_TRG_LIHC_mutations",
                  "Entropy_TRG_SKCM_mutations",
                  "Entropy_TRG_LUSC_mutations",
                  "Entropy_TRG_CHOL_mutations",
                  "Entropy_TRG_UCEC_mutations",
                  "Entropy_TRG_HNSC_mutations",
                  "Entropy_TRG_BLCA_mutations",
                  "Clonality_IGL_PRAD_mutations",
                  "Clonality_IGL_CHOL_mutations",
                  "Clonality_IGL_BLCA_mutations",
                  "Clonality_IGL_KIRC_mutations",
                  "Clonality_IGL_HNSC_mutations",
                  "Clonality_IGL_SKCM_mutations",
                  "Clonality_IGL_UCEC_mutations",
                  "Clonality_IGL_KIRP_mutations",
                  "Clonality_IGL_LIHC_mutations",
                  "Clonality_IGL_BRCA_mutations",
                  "Clonality_IGL_LUSC_mutations",
                  "Clonality_IGL_KICH_mutations",
                  "Clonality_IGL_ESCA_mutations",
                  "Clonality_IGL_LUAD_mutations",
                  "Entropy_TRD_UCS_mutations",
                  "Entropy_TRD_ESCA_mutations",
                  "Entropy_TRD_BRCA_mutations",
                  "Entropy_TRD_CHOL_mutations",
                  "Entropy_TRD_LIHC_mutations",
                  "Entropy_TRD_LUSC_mutations",
                  "Entropy_TRD_LUAD_mutations",
                  "Abundance_IGH_LIHC_mutations",
                  "Abundance_IGH_LUSC_mutations",
                  "Abundance_IGH_ESCA_mutations",
                  "Abundance_IGH_BRCA_mutations",
                  "Abundance_IGH_BLCA_mutations",
                  "Abundance_IGH_KICH_mutations",
                  "Abundance_IGH_UCEC_mutations",
                  "Abundance_IGH_KIRC_mutations",
                  "Abundance_IGH_PRAD_mutations",
                  "Abundance_IGH_CHOL_mutations",
                  "Abundance_IGH_LUAD_mutations",
                  "Abundance_IGH_SKCM_mutations",
                  "Abundance_IGH_HNSC_mutations",
                  "Abundance_IGH_KIRP_mutations",
                  "Abundance_TRD_HNSC_mutations",
                  "Abundance_TRD_LUSC_mutations",
                  "Abundance_TRD_LUAD_mutations",
                  "Abundance_TRD_BRCA_mutations",
                  "Abundance_TRD_BLCA_mutations",
                  "Abundance_TRD_PRAD_mutations",
                  "Abundance_TRD_KIRC_mutations",
                  "Abundance_TRD_SKCM_mutations",
                  "Abundance_TRD_LIHC_mutations",
                  "Abundance_TRD_CHOL_mutations",
                  "Abundance_TRD_UCEC_mutations",
                  "Abundance_TRD_KICH_mutations",
                  "Abundance_TRD_KIRP_mutations",
                  "Abundance_TRD_ESCA_mutations",
                  "Clonality_IGK_KIRC_mutations",
                  "Clonality_IGK_UCEC_mutations",
                  "Clonality_IGK_LUSC_mutations",
                  "Clonality_IGK_HNSC_mutations",
                  "Clonality_IGK_LIHC_mutations",
                  "Clonality_IGK_CHOL_mutations",
                  "Clonality_IGK_BRCA_mutations",
                  "Clonality_IGK_ESCA_mutations",
                  "Clonality_IGK_LUAD_mutations",
                  "Clonality_IGK_KICH_mutations",
                  "Clonality_IGK_PRAD_mutations",
                  "Clonality_IGK_KIRP_mutations",
                  "Clonality_IGK_SKCM_mutations",
                  "Clonality_IGK_BLCA_mutations",
                  "Abundance_TRA_KICH_mutations",
                  "Abundance_TRA_CHOL_mutations",
                  "Abundance_TRA_LUSC_mutations",
                  "Abundance_TRA_HNSC_mutations",
                  "Abundance_TRA_KIRC_mutations",
                  "Abundance_TRA_LUAD_mutations",
                  "Abundance_TRA_BRCA_mutations",
                  "Abundance_TRA_BLCA_mutations",
                  "Abundance_TRA_LIHC_mutations",
                  "Abundance_TRA_SKCM_mutations",
                  "Abundance_TRA_KIRP_mutations",
                  "Abundance_TRA_ESCA_mutations",
                  "Abundance_TRA_PRAD_mutations",
                  "Abundance_TRA_UCEC_mutations",
                  "Entropy_IGH_ESCA_mutations",
                  "Entropy_IGH_KICH_mutations",
                  "Entropy_IGH_LUAD_mutations",
                  "Entropy_IGH_BRCA_mutations",
                  "Entropy_IGH_LIHC_mutations",
                  "Entropy_IGH_BLCA_mutations",
                  "Entropy_IGH_HNSC_mutations",
                  "Entropy_IGH_LUSC_mutations",
                  "Entropy_IGH_KIRP_mutations",
                  "Entropy_IGH_CHOL_mutations",
                  "Entropy_IGH_KIRC_mutations",
                  "Entropy_IGH_SKCM_mutations",
                  "Entropy_IGH_UCEC_mutations",
                  "Entropy_IGH_PRAD_mutations",
                  "Abundance_IGK_LUSC_mutations",
                  "Abundance_IGK_KIRP_mutations",
                  "Abundance_IGK_LIHC_mutations",
                  "Abundance_IGK_UCEC_mutations",
                  "Abundance_IGK_LUAD_mutations",
                  "Abundance_IGK_CHOL_mutations",
                  "Abundance_IGK_BLCA_mutations",
                  "Abundance_IGK_KICH_mutations",
                  "Abundance_IGK_HNSC_mutations",
                  "Abundance_IGK_KIRC_mutations",
                  "Abundance_IGK_BRCA_mutations",
                  "Abundance_IGK_ESCA_mutations",
                  "Abundance_IGK_SKCM_mutations",
                  "Abundance_IGK_PRAD_mutations",
                  "Abundance_IGL_KIRC_mutations",
                  "Abundance_IGL_LIHC_mutations",
                  "Abundance_IGL_LUAD_mutations",
                  "Abundance_IGL_KICH_mutations",
                  "Abundance_IGL_ESCA_mutations",
                  "Abundance_IGL_BRCA_mutations",
                  "Abundance_IGL_KIRP_mutations",
                  "Abundance_IGL_HNSC_mutations",
                  "Abundance_IGL_SKCM_mutations",
                  "Abundance_IGL_LUSC_mutations",
                  "Abundance_IGL_BLCA_mutations",
                  "Abundance_IGL_CHOL_mutations",
                  "Abundance_IGL_UCEC_mutations",
                  "Abundance_IGL_PRAD_mutations",
                  "Entropy_TRB_BRCA_mutations",
                  "Entropy_TRB_CHOL_mutations",
                  "Entropy_TRB_KICH_mutations",
                  "Entropy_TRB_KIRC_mutations",
                  "Entropy_TRB_KIRP_mutations",
                  "Entropy_TRB_LUAD_mutations",
                  "Entropy_TRB_UCEC_mutations",
                  "Entropy_TRB_SKCM_mutations",
                  "Entropy_TRB_LUSC_mutations",
                  "Entropy_TRB_BLCA_mutations",
                  "Entropy_TRB_PRAD_mutations",
                  "Entropy_TRB_HNSC_mutations",
                  "Entropy_TRB_LIHC_mutations",
                  "Entropy_TRB_ESCA_mutations",
                  "Clonality_TRB_CHOL_mutations",
                  "Clonality_TRB_PRAD_mutations",
                  "Clonality_TRB_LUSC_mutations",
                  "Clonality_TRB_ESCA_mutations",
                  "Clonality_TRB_KIRC_mutations",
                  "Clonality_TRB_BRCA_mutations",
                  "Clonality_TRB_UCEC_mutations",
                  "Clonality_TRB_KICH_mutations",
                  "Clonality_TRB_LIHC_mutations",
                  "Clonality_TRB_SKCM_mutations",
                  "Clonality_TRB_LUAD_mutations",
                  "Clonality_TRB_KIRP_mutations",
                  "Clonality_TRB_BLCA_mutations",
                  "Clonality_TRB_HNSC_mutations",
                  "Clonality_IGH_UCEC_mutations",
                  "Clonality_IGH_LUSC_mutations",
                  "Clonality_IGH_LUAD_mutations",
                  "Clonality_IGH_KIRP_mutations",
                  "Clonality_IGH_CHOL_mutations",
                  "Clonality_IGH_KICH_mutations",
                  "Clonality_IGH_LIHC_mutations",
                  "Clonality_IGH_ESCA_mutations",
                  "Clonality_IGH_BLCA_mutations",
                  "Clonality_IGH_SKCM_mutations",
                  "Clonality_IGH_PRAD_mutations",
                  "Clonality_IGH_KIRC_mutations",
                  "Clonality_IGH_HNSC_mutations",
                  "Clonality_IGH_BRCA_mutations",
                  "Entropy_IGK_KIRC_mutations",
                  "Entropy_IGK_SKCM_mutations",
                  "Entropy_IGK_HNSC_mutations",
                  "Entropy_IGK_ESCA_mutations",
                  "Entropy_IGK_BRCA_mutations",
                  "Entropy_IGK_KICH_mutations",
                  "Entropy_IGK_KIRP_mutations",
                  "Entropy_IGK_UCEC_mutations",
                  "Entropy_IGK_PRAD_mutations",
                  "Entropy_IGK_BLCA_mutations",
                  "Entropy_IGK_LUAD_mutations",
                  "Entropy_IGK_LUSC_mutations",
                  "Entropy_IGK_CHOL_mutations",
                  "Entropy_IGK_LIHC_mutations",
                  "Abundance_TRG_KIRP_mutations",
                  "Abundance_TRG_KICH_mutations",
                  "Abundance_TRG_HNSC_mutations",
                  "Abundance_TRG_CHOL_mutations",
                  "Abundance_TRG_ESCA_mutations",
                  "Abundance_TRG_SKCM_mutations",
                  "Abundance_TRG_BRCA_mutations",
                  "Abundance_TRG_BLCA_mutations",
                  "Abundance_TRG_PRAD_mutations",
                  "Abundance_TRG_LIHC_mutations",
                  "Abundance_TRG_LUSC_mutations",
                  "Abundance_TRG_UCEC_mutations",
                  "Abundance_TRG_LUAD_mutations",
                  "Abundance_TRG_KIRC_mutations",
                  "Clonality_TRD_UCS_mutations",
                  "Clonality_TRD_LUAD_mutations",
                  "Clonality_TRD_LUSC_mutations",
                  "Clonality_TRD_ESCA_mutations",
                  "Clonality_TRD_CHOL_mutations",
                  "Clonality_TRD_LIHC_mutations",
                  "Clonality_TRD_BRCA_mutations",
                  "Clonality_TRA_BRCA_mutations",
                  "Clonality_TRA_CHOL_mutations",
                  "Clonality_TRA_KIRC_mutations",
                  "Clonality_TRA_HNSC_mutations",
                  "Clonality_TRA_KIRP_mutations",
                  "Clonality_TRA_BLCA_mutations",
                  "Clonality_TRA_SKCM_mutations",
                  "Clonality_TRA_LUSC_mutations",
                  "Clonality_TRA_UCEC_mutations",
                  "Clonality_TRA_ESCA_mutations",
                  "Clonality_TRA_LIHC_mutations",
                  "Clonality_TRA_LUAD_mutations",
                  "Clonality_TRA_PRAD_mutations",
                  "Clonality_TRA_KICH_mutations",
                  "Clonality_TRG_PRAD_mutations",
                  "Clonality_TRG_HNSC_mutations",
                  "Clonality_TRG_UCEC_mutations",
                  "Clonality_TRG_CHOL_mutations",
                  "Clonality_TRG_BRCA_mutations",
                  "Clonality_TRG_KIRP_mutations",
                  "Clonality_TRG_KICH_mutations",
                  "Clonality_TRG_ESCA_mutations",
                  "Clonality_TRG_LUAD_mutations",
                  "Clonality_TRG_SKCM_mutations",
                  "Clonality_TRG_KIRC_mutations",
                  "Clonality_TRG_LIHC_mutations",
                  "Clonality_TRG_BLCA_mutations",
                  "Clonality_TRG_LUSC_mutations",
                  "Entropy_TRA_KIRC_mutations",
                  "Entropy_TRA_LUAD_mutations",
                  "Entropy_TRA_SKCM_mutations",
                  "Entropy_TRA_LIHC_mutations",
                  "Entropy_TRA_ESCA_mutations",
                  "Entropy_TRA_BRCA_mutations",
                  "Entropy_TRA_UCEC_mutations",
                  "Entropy_TRA_PRAD_mutations",
                  "Entropy_TRA_CHOL_mutations",
                  "Entropy_TRA_LUSC_mutations",
                  "Entropy_TRA_KIRP_mutations",
                  "Entropy_TRA_BLCA_mutations",
                  "Entropy_TRA_KICH_mutations",
                  "Entropy_TRA_HNSC_mutations",
                  "Abundance_TRB_PRAD_mutations",
                  "Abundance_TRB_HNSC_mutations",
                  "Abundance_TRB_BLCA_mutations",
                  "Abundance_TRB_ESCA_mutations",
                  "Abundance_TRB_KIRP_mutations",
                  "Abundance_TRB_LUSC_mutations",
                  "Abundance_TRB_CHOL_mutations",
                  "Abundance_TRB_LUAD_mutations",
                  "Abundance_TRB_BRCA_mutations",
                  "Abundance_TRB_SKCM_mutations",
                  "Abundance_TRB_KICH_mutations",
                  "Abundance_TRB_UCEC_mutations",
                  "Abundance_TRB_KIRC_mutations",
                  "Abundance_TRB_LIHC_mutations",
                  "Entropy_IGL_CHOL_mutations",
                  "Entropy_IGL_SKCM_mutations",
                  "Entropy_IGL_LUAD_mutations",
                  "Entropy_IGL_KICH_mutations",
                  "Entropy_IGL_BLCA_mutations",
                  "Entropy_IGL_KIRP_mutations",
                  "Entropy_IGL_ESCA_mutations",
                  "Entropy_IGL_LUSC_mutations",
                  "Entropy_IGL_LIHC_mutations",
                  "Entropy_IGL_HNSC_mutations",
                  "Entropy_IGL_UCEC_mutations",
                  "Entropy_IGL_BRCA_mutations",
                  "Entropy_IGL_KIRC_mutations",
                  "Entropy_IGL_PRAD_mutations"),
  Reason = ''
)

kable(failure_data, format = "html", col.names = c("Phenotype and Tumor Type", "Reason for Failure"), align = 'l') %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F) %>%
  row_spec(0, bold = TRUE, background = "#337ab7", color = "white") 
```

# Extracting and Summarizing Analysis Results
This code segment scans through analysis output directories, identifies relevant result files (*_resdd.Rd), extracts corresponding tumor types, immune phenotypes, and analysis modes(sig/reg).
```{r}
get_files <- function(outputdir, tumors = NULL, phenotypes = NULL) {
  files <- list.files(
    path = outputdir,
    pattern = "_resdd\\.Rd$",
    recursive = TRUE,
    full.names = TRUE
  )
  
  matching_files_txt <- sub("\\.Rd$", ".txt", files)
  
  analysis_mode <- ifelse(grepl("_sig_", basename(files)), "sig", "reg")

  inner_folder_names      <- basename(dirname(files))            
  phenotype_folder_names  <- basename(dirname(dirname(files)))  
  
  tumor_names <- mapply(function(inner_name, phen) {
    pattern_front <- paste0("^", phen, "_")
    tmp <- sub(pattern_front, "", inner_name)
    tmp <- sub("_mutations$", "", tmp)
    return(tmp)
  }, inner_folder_names, phenotype_folder_names)
  
  phenos_all <- phenotype_folder_names
  
  filedf <- data.frame(
    tumor      = tumor_names,
    phenotype  = phenos_all,
    mode       = analysis_mode,   
    file       = files,
    filetxt    = matching_files_txt,
    stringsAsFactors = FALSE
  )
  
  if (!is.null(tumors)) {
    filedf <- filedf[filedf$tumor %in% tumors, ]
  }
  if (!is.null(phenotypes)) {
    filedf <- filedf[filedf$phenotype %in% phenotypes, ]
  }

  rownames(filedf) <- NULL
  return(filedf)
}

filedf <- get_files(
  outputdir = "/dartfs/rc/lab/S/Szhao/qiruiz/diffdriver/temp/output/diversity"
)

head(filedf)
```

# Summary Table of Significant Differential Genes
The provided function extracts and compiles results from analyses, filtering specifically for significant differential genes based on a threshold (**`dd.fdr < 0.1`**).  
```{r}
get_diff_table <- function(filedf){
  pheno_all <- unique(filedf$phenotype)
  numlist <- list()
  
  for (p in pheno_all){
    p_txtfiles <- filedf[filedf$phenotype == p, ]
    numlist[[p]] <- list()
    
    for (t in seq_len(nrow(p_txtfiles))){
      txtf  <- p_txtfiles[t, "filetxt"]
      rdf   <- p_txtfiles[t, "file"] 
      tumor <- p_txtfiles[t, "tumor"] 
      mode  <- p_txtfiles[t, "mode"]     # reg / sig
      
      env <- new.env()
      load(rdf, envir = env)
      res_rdata <- env$res
      
      res <- read.table(txtf, header = TRUE)
      res$gene <- row.names(res)
      res$mode <- mode
      
      res$alpha <- sapply(res$gene, function(gene){
          res_rdata[[gene]][["dd"]][["res.alt"]]$alpha[2]
      })
      
      sig_res <- res[res$dd.fdr < 0.1, ]
      if (nrow(sig_res) > 0){
        numlist[[p]][[ paste0(tumor, "_", mode) ]] <- sig_res
      }
    }
    
    if (length(numlist[[p]]) == 0){
      numlist[[p]] <- NULL
    }
  }
  
  combined_df <- do.call(
    rbind,
    lapply(names(numlist), function(pheno) {
      numlist.pheno <- numlist[[pheno]]
      df.pheno <- do.call(rbind, lapply(names(numlist.pheno), function(tname) {
        df <- numlist.pheno[[tname]]

        df$tumor <- sub("_.*", "", tname) 
        df$mode  <- sub(".*_", "", tname) 
        return(df)
      }))
      df.pheno$pheno <- pheno
      return(df.pheno)
    })
  )
  return(combined_df)
}

diff_table <- get_diff_table(filedf)
```

## Table under "Sig" Mode
```{r}
library(DT)
diff_table_sig <- subset(diff_table, mode == "sig")
datatable(diff_table_sig, options = list(pageLength = 10))
```

## Table under "Reg" Mode
```{r}
diff_table_reg <- subset(diff_table, mode == "reg")
datatable(diff_table_reg, options = list(pageLength = 10))
```

# Plotting the Number of Significant Differential Genes
The provided function generates bar plots illustrating the number of significantly differentially expressed genes (**dd.fdr < 0.1**) for each tumor type across different phenotype contexts.
```{r}
plot_diff_number <- function(filedf, mode = c("all", "reg", "sig")){
  mode <- match.arg(mode)
  
  if (mode != "all"){
    filedf <- filedf[filedf$mode == mode, ]
  }
  
  pheno_all <- unique(filedf$phenotype)
  numlist <- list()
  
  for (p in pheno_all){
    p_txtfiles <- filedf[filedf$phenotype == p, ]
    numlist[[p]] <- list()
    for (t in 1:nrow(p_txtfiles)){
      txtf <- p_txtfiles[t, "filetxt"]
      tumor <- p_txtfiles[t, "tumor"]
      res <- read.table(txtf, header = TRUE)
      numlist[[p]][[tumor]] <- c(
        nrow(res[res$dd.fdr < 0.1,]),
        nrow(res) - nrow(res[res$dd.fdr < 0.1,])
      )
    }
  }
  
  par(mfrow = c(length(numlist),1), mar = c(3,5,2,0))
  for (phenotype in names(numlist)) {
    colors <- rainbow(length(numlist[[phenotype]]))
    plot(
      NULL,
      xlim = c(0.5, length(numlist[[phenotype]]) + 0.5),
      ylim = c(0, max(unlist(sapply(numlist[[phenotype]], `[`, 1)))),
      xlab = "Tumor Type",
      ylab = "No. Genes",
      main = paste("Context:", phenotype),
      xaxt = "n", bty = 'n'
    )
    grid()
    
    axis(
      1,
      at = 1:length(numlist[[phenotype]]),
      labels = names(numlist[[phenotype]]),
      las = 2
    )
    
    for (i in seq_along(numlist[[phenotype]])) {
      bar_height <- numlist[[phenotype]][[i]][1]
      rect(i - 0.4, 0, i + 0.4, bar_height, col = colors[i], border = NA)
    }
  }
}
```

## Visualization under "Sig" Mode
```{r, fig.width=7, fig.height=20}  
plot_diff_number(filedf, mode = "sig")
```

## Visualization under "Reg" Mode
```{r, fig.width=7, fig.height=20}  
plot_diff_number(filedf, mode = "reg")
```

# Plot specific genes
To visualize the data for specific genes, diffdriver has a plotting function:
```{r}
mut_path <- "/dartfs/rc/lab/S/Szhao/qiruiz/diffdriver/tumor_specific_input/TGCT/TGCT_mutations.txt"
mut <- read.table(mut_path, header = TRUE, sep = "\t")
head(mut)
```

```{r}
pheno_path <- "/dartfs/rc/lab/S/Szhao/qiruiz/diffdriver/batch2/tumor_specific_input/TGCT/TGCT_C1.txt"
pheno <- read.table(pheno_path, header = TRUE, sep = "\t")
head(pheno)
```

```{r}
diffdriver::plot_mut(gene_name = "KIT", mut= mut, pheno = pheno, totalnttype = 96, 
                     anno_dir =  "/dartfs/rc/lab/S/Szhao/qiruiz/diffdriver/temp/annodir96")
```

