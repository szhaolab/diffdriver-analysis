---
title: "Immune Subtypes"
author: "Qirui Zhang"
date: "2025-04-16"
output: 
  html_document:
    theme: flatly
    highlight: tango
    toc: true
    toc_float: true
---

```{r}
knitr::opts_chunk$set(echo = TRUE)
```

# Overview

In total, **80 analyses** were conducted across **20 tumor types**, each classified into **4 distinct immune phenotype groups (C1–C4)**. Among these analyses, **70 completed successfully**, while **10 encountered errors**. The specific tumor type and phenotype combinations for unsuccessful analyses are detailed below.

# Summary of Unsuccessful Analyses

The table below summarizes analyses that failed, along with explanations for their failure:

```{r, echo=FALSE}
library(knitr)
library(kableExtra)

failure_data <- data.frame(
  Combination = c("C1_SKCM_mutations", "C2_SKCM_mutations", "C2_GBM_mutations", "C2_KICH_mutations",
                  "C3_GBM_mutations", "C3_CESC_mutations", "C3_LUSC_mutations", "C3_SKCM_mutations", 
                  "C3_UCS_mutations","C4_SKCM_mutations"),
  Reason = c("Insufficient data (only two samples)",
             "Insufficient data (only two samples)",
             rep("Lacked phenotype variation (all samples category 0)", 5),
             "Insufficient data (only two samples)",
             "Lacked phenotype variation (all samples category 0)",
             "Insufficient data (only two samples)")
)

kable(failure_data, format = "html", col.names = c("Phenotype and Tumor Type", "Reason for Failure"), align = 'l') %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F) %>%
  row_spec(0, bold = TRUE, background = "#337ab7", color = "white") 
```

# Extracting and Summarizing Analysis Results
This code segment scans through analysis output directories, identifies relevant result files (*_resdd.Rd), extracts corresponding tumor types, immune phenotypes, and analysis modes(sig/reg).
```{r}
get_files <- function(outputdir, tumors = NULL, phenotypes = NULL) {
  files <- list.files(
    path = outputdir,
    pattern = "_resdd\\.Rd$",
    recursive = TRUE,
    full.names = TRUE
  )
  
  matching_files_txt <- sub("\\.Rd$", ".txt", files)
  
  analysis_mode <- ifelse(grepl("_sig_", basename(files)), "sig", "reg")

  inner_folder_names      <- basename(dirname(files))            
  phenotype_folder_names  <- basename(dirname(dirname(files)))  
  
  tumor_names <- mapply(function(inner_name, phen) {
    pattern_front <- paste0("^", phen, "_")
    tmp <- sub(pattern_front, "", inner_name)
    tmp <- sub("_mutations$", "", tmp)
    return(tmp)
  }, inner_folder_names, phenotype_folder_names)
  
  phenos_all <- phenotype_folder_names
  
  filedf <- data.frame(
    tumor      = tumor_names,
    phenotype  = phenos_all,
    mode       = analysis_mode,   
    file       = files,
    filetxt    = matching_files_txt,
    stringsAsFactors = FALSE
  )
  
  if (!is.null(tumors)) {
    filedf <- filedf[filedf$tumor %in% tumors, ]
  }
  if (!is.null(phenotypes)) {
    filedf <- filedf[filedf$phenotype %in% phenotypes, ]
  }

  rownames(filedf) <- NULL
  return(filedf)
}

filedf <- get_files(
  outputdir = "/dartfs/rc/lab/S/Szhao/qiruiz/diffdriver/temp/output/new_plot/immunesubtypes"
)

head(filedf)
```

# Summary Table of Significant Differential Genes
The provided function extracts and compiles results from analyses, filtering specifically for significant differential genes based on a threshold (**`dd.fdr < 0.1`**).  
```{r}
get_diff_table <- function(filedf, include_nonsig = TRUE){
  pheno_all <- unique(filedf$phenotype)
  numlist <- list()
  
  for (p in pheno_all){
    p_txtfiles <- filedf[filedf$phenotype == p, ]
    numlist[[p]] <- list()
    
    for (t in seq_len(nrow(p_txtfiles))){
      txtf  <- p_txtfiles[t, "filetxt"]
      rdf   <- p_txtfiles[t, "file"] 
      tumor <- p_txtfiles[t, "tumor"] 
      mode  <- p_txtfiles[t, "mode"]     # reg / sig
      
      env <- new.env()
      load(rdf, envir = env)
      res_rdata <- env$res
      
      res <- read.table(txtf, header = TRUE)
      res$gene <- row.names(res)
      res$mode <- mode
      
      res$alpha <- sapply(res$gene, function(gene){
          res_rdata[[gene]][["dd"]][["res.alt"]]$alpha[2]
      })
      
      res$significant <- res$dd.fdr < 0.1
      
      if (include_nonsig) {
        numlist[[p]][[ paste0(tumor, "_", mode) ]] <- res
      } else {
        sig_res <- res[res$dd.fdr < 0.1, ]
        if (nrow(sig_res) > 0){
          numlist[[p]][[ paste0(tumor, "_", mode) ]] <- sig_res
        }
      }
    }
    
    if (length(numlist[[p]]) == 0){
      numlist[[p]] <- NULL
    }
  }
  
  combined_df <- do.call(
    rbind,
    lapply(names(numlist), function(pheno) {
      numlist.pheno <- numlist[[pheno]]
      df.pheno <- do.call(rbind, lapply(names(numlist.pheno), function(tname) {
        df <- numlist.pheno[[tname]]
        df$tumor <- sub("_.*", "", tname) 
        df$mode  <- sub(".*_", "", tname) 
        return(df)
      }))
      df.pheno$pheno <- pheno
      return(df.pheno)
    })
  )
  return(combined_df)
}

diff_table_all <- get_diff_table(filedf, include_nonsig = TRUE)
diff_table <-  get_diff_table(filedf, include_nonsig = FALSE)
```

## Table under "Sig" Mode
```{r}
library(DT)
diff_table_sig <- subset(diff_table, mode == "sig")
datatable(diff_table_sig, options = list(pageLength = 10))
```

## Table under "Reg" Mode
```{r}
diff_table_reg <- subset(diff_table, mode == "reg")
datatable(diff_table_reg, options = list(pageLength = 10))
```

# Plotting the Number of Significant Differential Genes
The provided function generates bar plots illustrating the number of significantly differentially expressed genes (**dd.fdr < 0.1**) for each tumor type across immune phenotype contexts (C1–C4).
```{r}
library(scales)

plot_diff_number <- function(filedf, mode = c("reg", "sig")){
  
  filedf <- filedf[filedf$mode == mode, ]
  
  pheno_all <- unique(filedf$phenotype)
  numlist <- list()
  
  pt <- scales::pseudo_log_trans()
  
  for (p in pheno_all){
    p_txtfiles <- filedf[filedf$phenotype == p, ]
    numlist[[p]] <- list()
    for (t in 1:nrow(p_txtfiles)){
      txtf <- p_txtfiles[t, "filetxt"]
      tumor <- p_txtfiles[t, "tumor"]
      res <- read.table(txtf, header = TRUE)
      numlist[[p]][[tumor]] <- c(
        nrow(res[res$dd.fdr < 0.1,]),
        nrow(res) - nrow(res[res$dd.fdr < 0.1,])
      )
    }
  }
  
  par(mfrow = c(length(numlist),1), mar = c(3,5,2,0))
  for (phenotype in names(numlist)) {
    colors <- rainbow(length(numlist[[phenotype]]))
    max_height <- max(unlist(lapply(numlist[[phenotype]], function(x) sum(x))))
    
    max_plot_height <- pt$transform(max_height)
    
    plot(
      NULL,
      xlim = c(0.5, length(numlist[[phenotype]]) + 0.5),
      ylim = c(0, max_plot_height * 1.1),
      xlab = "Tumor Type",
      ylab = "No. Genes",
      main = paste("Context:", phenotype),
      xaxt = "n", yaxt = "n", bty = 'n'
    )
    
    y_ticks <- c(0, 1, 2, 5, 10, 30, 60)
    y_ticks <- y_ticks[y_ticks <= max_height]
    axis(2, at = pt$transform(y_ticks), labels = y_ticks)
    
    grid()

    axis(
      1,
      at = 1:length(numlist[[phenotype]]),
      labels = names(numlist[[phenotype]]),
      las = 2
    )
    
    for (i in seq_along(numlist[[phenotype]])) {
      sig_count <- numlist[[phenotype]][[i]][1]
      nonsig_count <- numlist[[phenotype]][[i]][2]

      rect(i - 0.4, pt$transform(sig_count), i + 0.4, 
          pt$transform(sig_count + nonsig_count),
          col = adjustcolor(colors[i], alpha.f = 0.15), 
          border = NA)
      
      if (sig_count > 0) {
        rect(i - 0.4, pt$transform(0), i + 0.4, pt$transform(sig_count),
             col = colors[i], border = NA)
        text(i, pt$transform(sig_count) * 1.2, sig_count, cex = 0.7)
      }
    }
    
  }
}
```

## Visualization under "Sig" Mode
```{r, fig.width=7, fig.height=5} 
plot_diff_number(filedf, mode = "sig")
```

## Visualization under "Reg" Mode
```{r, fig.width=7, fig.height=5} 
plot_diff_number(filedf, mode = "reg")
```

# Multi-Faceted Dot Plot for Differential Gene Analysis
This function generates a series of dot plots to illustrate differential gene analysis results across various tumors and phenotypes. Each plot highlights significance (positive, negative, non-significant), p-values, and relative effect sizes.
```{r}
library(dplyr)
library(ggplot2)

plot_diff_gene <- function(diff_table_all, filedf, mode = c("sig", "reg")) {
  dt <- diff_table_all[diff_table_all$mode == mode, ]
  
  all_tumors <- sort(unique(filedf$tumor))
  all_phenos <- sort(unique(filedf$phenotype))
   
  dt <- dt %>%
    mutate(
      tumor = factor(tumor, levels = all_tumors),
      pheno = factor(pheno, levels = all_phenos)
    )
  
  gene_order <- dt %>%
    group_by(gene) %>%
    summarise(n = n()) %>%
    arrange(desc(n)) %>%
    pull(gene)
  
  dt <- dt %>% mutate(gene = factor(gene, levels = gene_order))

  all_genes  <- levels(dt$gene)

  plots_list <- list()

  for (current_gene in all_genes) {
    df_gene <- dt %>% filter(gene == current_gene)
    
    full_grid <- expand.grid(
      tumor = all_tumors,
      pheno = all_phenos,
      KEEP.OUT.ATTRS = FALSE
    )
    full_grid$tumor <- factor(full_grid$tumor, levels = all_tumors)
    full_grid$pheno <- factor(full_grid$pheno, levels = all_phenos)
    
    df_plot <- full_grid %>%
      left_join(df_gene, by = c("tumor", "pheno")) %>%
      mutate(
        signcat = case_when(
          is.na(significant)                 ~ "none",
          significant == FALSE               ~ "ns",
          significant == TRUE & alpha > 0    ~ "pos",
          significant == TRUE & alpha < 0    ~ "neg"
        ),
        pvalue = dd.p,
        log_pvalue = case_when(
          !is.na(dd.p) & dd.p > 0 ~ -log10(dd.p),
          !is.na(dd.p) & dd.p == 0 ~ 10,
          TRUE ~ NA_real_
        ),
        signed_log_pvalue = case_when(
          signcat == "pos" ~ log_pvalue,
          signcat == "neg" ~ -log_pvalue,
          TRUE ~ NA_real_
        )
    ) %>%
    group_by(pheno) %>%
      mutate(
        ref_alpha = median(abs(alpha), na.rm = TRUE),  # mean/max/a specified tumor
        ratio_alpha = if_else(is.na(ref_alpha) | ref_alpha == 0, 
                              NA_real_, 
                              abs(alpha) / ref_alpha), 
        size_value = case_when(
          signcat %in% c("pos", "neg", "ns") ~ ratio_alpha,
          TRUE                               ~ NA_real_
        )
      ) %>%
      ungroup()
    
    p <- ggplot() +
      # For significant points (both positive and negative)
      geom_point(
        data = df_plot %>% filter(signcat %in% c("pos", "neg")),
        aes(x = tumor, y = pheno, size = size_value, fill = signed_log_pvalue),
        shape = 21,
        color = "black", 
        stroke = 0.2, 
        na.rm = TRUE
      ) +
      # For non-significant points
      geom_point(
        data = df_plot %>% filter(signcat == "ns"),
        aes(x = tumor, y = pheno, size = size_value),
        shape = 21,
        fill = "grey90",
        color = "black",
        stroke = 0.2,
        alpha = 0.3,
        na.rm = TRUE
      ) +
      geom_blank(
        data = df_plot %>% filter(signcat == "none"),
        aes(x = tumor, y = pheno)
      ) +
      
      scale_fill_gradient2(
        low = "darkblue", 
        mid = "white",
        high = "darkred",
        midpoint = 0,
        name = "Directional Significance\n(-log10 p-value)",
        guide = guide_colorbar(direction = "vertical"),
        na.value = "orange",
        limits = c(-10, 10),
        oob = scales::squish
      ) +
  
      scale_size_continuous(
        range = c(1, 8), 
        name = "Relative size (|alpha| / ref)"
      ) +
      
      scale_x_discrete(drop = FALSE) +
      scale_y_discrete(drop = FALSE) +
      
      theme_bw(base_size = 14) +
      theme(
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
        legend.position = "right",
        legend.box = "vertical"
      ) +
      labs(
        x = "Tumor",
        y = "Phenotype",
        title = paste("Gene:", current_gene, "Mode:", mode)
      )
    
    plots_list[[current_gene]] <- p
  }
  
  return(plots_list)
}
```

```{r, fig.width=10, fig.height=5}
plots <- plot_diff_gene(diff_table_all, filedf, mode = "sig")
print(plots[["TP53"]])
print(plots[["KRAS"]])
# plot_diff_gene(diff_table_all, filedf, mode = "sig")
```

# Plot specific genes
To visualize the data for specific genes, diffdriver has a plotting function:
```{r}
mut_path <- "/dartfs/rc/lab/S/Szhao/qiruiz/diffdriver/tumor_specific_input/TGCT/TGCT_mutations.txt"
mut <- read.table(mut_path, header = TRUE, sep = "\t")
head(mut)
```

```{r}
pheno_path <- "/dartfs/rc/lab/S/Szhao/qiruiz/diffdriver/batch2/tumor_specific_input/TGCT/TGCT_C1.txt"
pheno <- read.table(pheno_path, header = TRUE, sep = "\t")
head(pheno)
```

```{r}
diffdriver::plot_mut(gene_name = "KIT", mut= mut, pheno = pheno, totalnttype = 96, 
                     anno_dir =  "/dartfs/rc/lab/S/Szhao/qiruiz/diffdriver/temp/annodir96")
```

