---
title: "Clinical_Newplot"
author: "Qirui Zhang"
date: "2025-04-14"
output: 
  html_document:
    theme: flatly
    highlight: tango
    toc: true
    toc_float: true
---

```{r}
knitr::opts_chunk$set(echo = TRUE)
```

# Overview

In total, **160 analyses** were conducted across **20 tumor types**, involving the following **6 distinct phenotypes**:

- Aneuploidy Score  
- Fraction Genome Altered  
- Months of Disease-specific Survival  
- Tumor Mutation Burden (TMB nonsynonymous)  
- Diagnosis Age  
- Progression-Free Survival Months  

All **160 analyses** were successfully completed without errors.

# Extracting and Summarizing Analysis Results
This code segment scans through analysis output directories, identifies relevant result files (*_resdd.Rd), extracts corresponding tumor types, immune phenotypes, and analysis modes(sig/reg).
```{r}
get_files <- function(outputdir, tumors = NULL, phenotypes = NULL) {
  files <- list.files(
    path = outputdir,
    pattern = "_resdd\\.Rd$",
    recursive = TRUE,
    full.names = TRUE
  )
  
  matching_files_txt <- sub("\\.Rd$", ".txt", files)
  
  analysis_mode <- ifelse(grepl("_sig_", basename(files)), "sig", "reg")

  inner_folder_names      <- basename(dirname(files))            # e.g. "Aneuploidy.Score_BLCA_mutations"
  phenotype_folder_names  <- basename(dirname(dirname(files)))   # e.g. "Aneuploidy.Score"
  
  tumor_names <- mapply(function(inner_name, phen) {
    pattern_front <- paste0("^", phen, "_")
    tmp <- sub(pattern_front, "", inner_name)
    tmp <- sub("_mutations$", "", tmp)
    return(tmp)
  }, inner_folder_names, phenotype_folder_names)
  
  phenos_all <- phenotype_folder_names
  
  filedf <- data.frame(
    tumor      = tumor_names,
    phenotype  = phenos_all,
    mode       = analysis_mode,   
    file       = files,
    filetxt    = matching_files_txt,
    stringsAsFactors = FALSE
  )
  
  if (!is.null(tumors)) {
    filedf <- filedf[filedf$tumor %in% tumors, ]
  }
  if (!is.null(phenotypes)) {
    filedf <- filedf[filedf$phenotype %in% phenotypes, ]
  }

  rownames(filedf) <- NULL
  return(filedf)
}

filedf <- get_files(
  outputdir = "/dartfs/rc/lab/S/Szhao/qiruiz/diffdriver/temp/output/new_plot/clinical"
)

head(filedf)
```

# Summary Table of Significant Differential Genes
The provided function extracts and compiles results from analyses, filtering specifically for significant differential genes based on a threshold (**`dd.fdr < 0.1`**). 
```{r}
get_diff_table <- function(filedf, include_nonsig = TRUE){
  pheno_all <- unique(filedf$phenotype)
  numlist <- list()
  
  for (p in pheno_all){
    p_txtfiles <- filedf[filedf$phenotype == p, ]
    numlist[[p]] <- list()
    
    for (t in seq_len(nrow(p_txtfiles))){
      txtf  <- p_txtfiles[t, "filetxt"]
      rdf   <- p_txtfiles[t, "file"] 
      tumor <- p_txtfiles[t, "tumor"] 
      mode  <- p_txtfiles[t, "mode"]     # reg / sig
      
      env <- new.env()
      load(rdf, envir = env)
      res_rdata <- env$res
      
      res <- read.table(txtf, header = TRUE)
      res$gene <- row.names(res)
      res$mode <- mode
      
      res$alpha <- sapply(res$gene, function(gene){
          res_rdata[[gene]][["dd"]][["res.alt"]]$alpha[2]
      })
      
      res$significant <- res$dd.fdr < 0.1
      
      if (include_nonsig) {
        numlist[[p]][[ paste0(tumor, "_", mode) ]] <- res
      } else {
        sig_res <- res[res$dd.fdr < 0.1, ]
        if (nrow(sig_res) > 0){
          numlist[[p]][[ paste0(tumor, "_", mode) ]] <- sig_res
        }
      }
    }
    
    if (length(numlist[[p]]) == 0){
      numlist[[p]] <- NULL
    }
  }
  
  combined_df <- do.call(
    rbind,
    lapply(names(numlist), function(pheno) {
      numlist.pheno <- numlist[[pheno]]
      df.pheno <- do.call(rbind, lapply(names(numlist.pheno), function(tname) {
        df <- numlist.pheno[[tname]]
        df$tumor <- sub("_.*", "", tname) 
        df$mode  <- sub(".*_", "", tname) 
        return(df)
      }))
      df.pheno$pheno <- pheno
      return(df.pheno)
    })
  )
  return(combined_df)
}

diff_table_all <- get_diff_table(filedf, include_nonsig = TRUE)
diff_table <-  get_diff_table(filedf, include_nonsig = FALSE)
```

## Table under "Sig" Mode
```{r}
library(DT)
diff_table_sig <- subset(diff_table_all, mode == "sig")
datatable(diff_table_sig, options = list(pageLength = 10))
```


## Table under "Reg" Mode
```{r}
diff_table_reg <- subset(diff_table, mode == "reg")
datatable(diff_table_reg, options = list(pageLength = 10))
```

# Plotting the Number of Significant Differential Genes
The provided function generates bar plots illustrating the number of significantly differentially expressed genes (**`dd.fdr < 0.1`**) for each tumor type across different phenotype contexts.
```{r}
plot_diff_number <- function(filedf, mode = c("all", "reg", "sig"), pseudocount = 1){
  mode <- match.arg(mode)
  
  if (mode != "all"){
    filedf <- filedf[filedf$mode == mode, ]
  }
  
  pheno_all <- unique(filedf$phenotype)
  numlist <- list()
  
  for (p in pheno_all){
    p_txtfiles <- filedf[filedf$phenotype == p, ]
    numlist[[p]] <- list()
    for (t in 1:nrow(p_txtfiles)){
      txtf <- p_txtfiles[t, "filetxt"]
      tumor <- p_txtfiles[t, "tumor"]
      res <- read.table(txtf, header = TRUE)
      numlist[[p]][[tumor]] <- c(
        nrow(res[res$dd.fdr < 0.1,]),
        nrow(res) - nrow(res[res$dd.fdr < 0.1,])
      )
    }
  }
  
  par(mfrow = c(length(numlist),1), mar = c(3,5,2,0))
  for (phenotype in names(numlist)) {
    colors <- rainbow(length(numlist[[phenotype]]))
    max_height <- max(unlist(lapply(numlist[[phenotype]], function(x) sum(x))))
    plot(
      NULL,
      xlim = c(0.5, length(numlist[[phenotype]]) + 0.5),
      ylim = c(pseudocount, max_height + pseudocount),
      log = "y",
      yaxt = "n", 
      xlab = "Tumor Type",
      ylab = "No. Genes",
      main = paste("Context:", phenotype),
      xaxt = "n", bty = 'n'
    )

    grid()
    
    yTicks <- axTicks(2)
    yLabels <- yTicks

    if (length(yLabels) > 0 && yLabels[1] == 1) {
      yLabels[1] <- 0  # or yTicks <- yTicks[-1]
    }

    axis(2, at = yTicks, labels = yLabels)

    axis(
      1,
      at = 1:length(numlist[[phenotype]]),
      labels = names(numlist[[phenotype]]),
      las = 2
    )
    
    for (i in seq_along(numlist[[phenotype]])) {
      sig_count <- numlist[[phenotype]][[i]][1]
      nonsig_count <- numlist[[phenotype]][[i]][2]
      total_count <- sig_count + nonsig_count
      
      sig_adj <- sig_count + pseudocount
      total_adj <- total_count + pseudocount
      rect(i - 0.4, pseudocount, i + 0.4, sig_adj, col = colors[i], border = NA)
      
      transparent_color <- adjustcolor(colors[i], alpha.f = 0.15)
      rect(i - 0.4, sig_adj, i + 0.4, total_adj, 
           col = transparent_color, border = NA)
      
      text(i, sig_adj * 1.2, numlist[[phenotype]][[i]][1], cex = 0.7)
    }
    
    # legend("topright", 
    #        legend = c("Significant (FDR < 0.1)", "Non-significant"), 
    #        fill = c(colors[1], adjustcolor(colors[1], alpha.f = 0.3)),
    #        border = NA, bty = "n")
  }
}
```

## Visualization under "Sig" Mode
```{r, fig.width=7, fig.height=8} 
plot_diff_number(filedf, mode = "sig")
```

## Visualization under "Reg" Mode
```{r, fig.width=7, fig.height=8} 
plot_diff_number(filedf, mode = "reg")
```



```{r}
library(dplyr)
library(ggplot2)

plot_diff_gene <- function(diff_table_all, filedf, mode = c("sig", "reg")) {
  dt <- diff_table_all[diff_table_all$mode == mode, ]
  
  all_tumors <- sort(unique(filedf$tumor))
  all_phenos <- sort(unique(filedf$phenotype))
  
  dt <- dt %>%
    mutate(
      tumor = factor(tumor, levels = all_tumors),
      pheno = factor(pheno, levels = all_phenos)
    )
  
  gene_order <- dt %>%
    group_by(gene) %>%
    summarise(n = n()) %>%
    arrange(desc(n)) %>%
    pull(gene)
  
  dt <- dt %>% mutate(gene = factor(gene, levels = gene_order))

  all_genes  <- levels(dt$gene)

  plots_list <- list()

  for (current_gene in all_genes) {
    df_gene <- dt %>% filter(gene == current_gene)
    
    full_grid <- expand.grid(
      tumor = all_tumors,
      pheno = all_phenos,
      KEEP.OUT.ATTRS = FALSE
    )
    full_grid$tumor <- factor(full_grid$tumor, levels = all_tumors)
    full_grid$pheno <- factor(full_grid$pheno, levels = all_phenos)
    
    df_plot <- full_grid %>%
      left_join(df_gene, by = c("tumor", "pheno")) %>%
      mutate(
        signcat = case_when(
          is.na(significant)                 ~ "none",
          significant == FALSE               ~ "ns",
          significant == TRUE & alpha > 0    ~ "pos",
          significant == TRUE & alpha < 0    ~ "neg"
        ),
        size_value = case_when(
          signcat %in% c("pos", "neg") ~ abs(alpha),
          signcat == "ns"             ~ 0.5,
          signcat == "none"           ~ NA_real_
        )
      )

    p <- ggplot() +
      geom_point(
        data = df_plot %>% filter(signcat %in% c("pos", "neg")),
        aes(x = tumor, y = pheno, color = signcat, size = abs(alpha)),
        alpha = 0.8,
        na.rm = TRUE
      ) +
      geom_point(
        data = df_plot %>% filter(signcat == "ns"),
        aes(x = tumor, y = pheno, color = signcat),
        size = 1,       
        alpha = 0.8,
        na.rm = TRUE
      ) +
      geom_blank(
        data = df_plot %>% filter(signcat == "none"),
        aes(x = tumor, y = pheno)
      ) +
      scale_color_manual(
        values = c("pos" = "red", "neg" = "blue", "ns" = "grey70", "none" = NA),
        breaks = c("pos", "neg", "ns"),  
        labels = c(
          "pos" = "pos-significant",
          "neg" = "neg-significant",
          "ns"  = "none-significant"
        ),
        name = "Significance",
        na.value = NA
      ) +
      scale_size_continuous(range = c(1, 8), guide = "none") +
      scale_x_discrete(drop = FALSE) +
      scale_y_discrete(drop = FALSE) +
      theme_bw(base_size = 14) +
      theme(
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
        legend.position = "right"
      ) +
      labs(
        x = "Tumor",
        y = "Phenotype",
        color = "Significance",
        title = paste("Gene:", current_gene, "Mode:", mode)
      )
    
    plots_list[[current_gene]] <- p
  }
  
  return(plots_list)
}
```

```{r, fig.width=10, fig.height=5}
plots <- plot_diff_gene(diff_table_all, filedf, mode = "sig")
print(plots[["TP53"]])
# plot_diff_gene(diff_table_all, filedf, mode = "sig")
```

```{r, fig.width=10, fig.height=5}
plots <- plot_diff_gene(diff_table_all, filedf, mode = "reg")
print(plots[["TP53"]])
# plot_diff_gene(diff_table_all, filedf, mode = "sig")
```

# Plot specific genes
To visualize the data for specific genes, diffdriver has a plotting function:
```{r}
mut_path <- "/dartfs/rc/lab/S/Szhao/qiruiz/diffdriver/tumor_specific_input/HNSC/HNSC_mutations.txt"
mut <- read.table(mut_path, header = TRUE, sep = "\t")
head(mut)
```

```{r}
pheno_path <- "/dartfs/rc/lab/S/Szhao/qiruiz/diffdriver/cbioportal_download/Aneuploidy.Score.txt"
pheno <- read.table(pheno_path, header = TRUE, sep = "\t")
head(pheno)
```

```{r}
diffdriver::plot_mut(gene_name = "CDKN2A", mut= mut, pheno = pheno, totalnttype = 96, 
                     anno_dir =  "/dartfs/rc/lab/S/Szhao/qiruiz/diffdriver/temp/annodir96")
```
